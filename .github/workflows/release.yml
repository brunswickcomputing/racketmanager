name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-zip:
    name: Build plugin zip
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Composer dependencies (no-dev)
        run: composer install --no-dev -o

      - name: Install NPM dependencies
        run: npm install

      - name: Build assets (production)
        run: npm run build:prod

      - name: Verify build outputs
        run: |
          test -f dist/js/racketmanager.js || (echo 'Missing dist/js/racketmanager.js' && exit 1)
          test -f dist/css/style.css || (echo 'Missing dist/css/style.css' && exit 1)
          test -f dist/css/admin.css || (echo 'Missing dist/css/admin.css' && exit 1)
          test -f dist/css/modal.css || (echo 'Missing dist/css/modal.css' && exit 1)
          test -f dist/css/print.css || (echo 'Missing dist/css/print.css' && exit 1)

      - name: Set variables
        id: vars
        run: |
          echo "tag=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          echo "plugin=racketmanager" >> $GITHUB_OUTPUT

      - name: Create plugin archive
        run: |
          mkdir -p build
          ZIP_NAME="${{ steps.vars.outputs.plugin }}-${{ steps.vars.outputs.version }}.zip"
          # Create staging directory matching WordPress plugin layout
          STAGE_DIR="build/${{ steps.vars.outputs.plugin }}"
          mkdir -p "$STAGE_DIR"
          rsync -av \
            --include='racketmanager.php' \
            --include='composer.json' \
            --include='vendor/***' \
            --include='src/***' \
            --include='templates/***' \
            --include='dist/***' \
            --include='assets/***' \
            --exclude='*' \
            ./ "$STAGE_DIR"/
          cd build
          zip -r "$ZIP_NAME" "${{ steps.vars.outputs.plugin }}" >/dev/null
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Generate checksum
        run: |
          cd build
          sha256sum "$ZIP_NAME" > "$ZIP_NAME.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-build
          path: |
            build/${{ env.ZIP_NAME }}
            build/${{ env.ZIP_NAME }}.sha256

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-zip
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: plugin-build
          path: build

      - name: Extract version from tag
        id: vars
        run: |
          echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.version }}
          name: RacketManager ${{ steps.vars.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.vars.outputs.version, 'rc') || contains(steps.vars.outputs.version, 'beta') || contains(steps.vars.outputs.version, 'alpha') }}
          files: |
            build/*.zip
            build/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
