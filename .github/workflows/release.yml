name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

jobs:
  build-zip:
    name: Build plugin zip
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # actions/checkout@v6.0.1

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1  # shivammathur/setup-php@2.36.0
        with:
          php-version: '8.3'
          extensions: intl
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # actions/setup-node@v6.1.0
        with:
          node-version: '20'

      - name: Install Composer dependencies (no-dev)
        run: composer install --no-dev -o

      - name: Install NPM dependencies
        run: npm install

      - name: Build assets (production)
        run: npm run build:prod

      - name: Verify build outputs
        run: |
          test -f dist/js/racketmanager.js || (echo 'Missing dist/js/racketmanager.js' && exit 1)
          test -f dist/css/style.css || (echo 'Missing dist/css/style.css' && exit 1)
          test -f dist/css/admin.css || (echo 'Missing dist/css/admin.css' && exit 1)
          test -f dist/css/modal.css || (echo 'Missing dist/css/modal.css' && exit 1)
          test -f dist/css/print.css || (echo 'Missing dist/css/print.css' && exit 1)

      - name: Set variables
        id: vars
        run: |
          echo "tag=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          echo "plugin=racketmanager" >> $GITHUB_OUTPUT

      - name: Create plugin archive
        run: |
          mkdir -p build
          ZIP_NAME="${{ steps.vars.outputs.plugin }}-${{ steps.vars.outputs.version }}.zip"
          # Create staging directory matching WordPress plugin layout
          STAGE_DIR="build/${{ steps.vars.outputs.plugin }}"
          mkdir -p "$STAGE_DIR"
          rsync -av \
            --include='racketmanager.php' \
            --include='composer.json' \
            --include='vendor/***' \
            --include='src/***' \
            --include='templates/***' \
            --include='dist/***' \
            --include='assets/***' \
            --exclude='*' \
            ./ "$STAGE_DIR"/
          cd build
          zip -r "$ZIP_NAME" "${{ steps.vars.outputs.plugin }}" >/dev/null
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Generate checksum
        run: |
          cd build
          sha256sum "$ZIP_NAME" > "$ZIP_NAME.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # actions/upload-artifact@v5.0.0
        with:
          name: plugin-build
          path: |
            build/${{ env.ZIP_NAME }}
            build/${{ env.ZIP_NAME }}.sha256

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-zip
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # actions/download-artifact@v6.0.0
        with:
          name: plugin-build
          path: build

      - name: Extract version from tag
        id: vars
        run: |
          echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.version }}
          name: RacketManager ${{ steps.vars.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.vars.outputs.version, 'rc') || contains(steps.vars.outputs.version, 'beta') || contains(steps.vars.outputs.version, 'alpha') }}
          files: |
            build/*.zip
            build/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
